<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>职场透镜 (Project Lens) v5.0</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.8/dist/purify.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&family=Inter:wght@400;500;700&display=swap');
        :root { --background-color: #121212; --surface-color: #1e1e1e; --primary-color: #9b59b6; --text-color: #e0e0e0; --text-secondary-color: #a0a0a0; --border-color: #333; --card-padding: 30px; }
        html.light-mode { --background-color: #f4f5f7; --surface-color: #ffffff; --primary-color: #007bff; --text-color: #333333; --text-secondary-color: #777777; --border-color: #e0e0e0; }
        body { font-family: 'Inter', 'Noto Sans SC', 'Noto Sans TC', sans-serif; background-color: var(--background-color); color: var(--text-color); margin: 0; padding: 20px; box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }
        .header { width: 100%; max-width: 1400px; margin: 0 auto 20px auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 24px; font-weight: 700; }
        .controls { display: flex; align-items: center; gap: 15px; }
        .theme-switcher { background: none; border: 1px solid var(--border-color); color: var(--text-secondary-color); cursor: pointer; font-size: 24px; padding: 5px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .theme-switcher:hover { color: var(--text-color); background-color: var(--surface-color); }
        .main-container { display: flex; gap: 20px; width: 100%; max-width: 1400px; margin: 0 auto; height: calc(100vh - 100px); }
        .panel { background-color: var(--surface-color); border-radius: 16px; border: 1px solid var(--border-color); padding: var(--card-padding); box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: background-color 0.3s, border-color 0.3s; display: flex; flex-direction: column; }
        .input-panel, .output-panel { flex: 1; overflow-y: auto; }
        h1 { font-size: 28px; margin-top: 0; margin-bottom: 10px; }
        .subtitle { color: var(--text-secondary-color); margin-bottom: 25px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 500; margin-bottom: 8px; font-size: 14px; }
        textarea, input[type="text"] { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 15px; box-sizing: border-box; background-color: var(--background-color); color: var(--text-color); }
        textarea { resize: vertical; }
        .analyze-button { width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s; display: flex; justify-content: center; align-items: center; margin-top: auto; }
        .analyze-button:disabled { background: #555; cursor: not-allowed; }
        #result-container { line-height: 1.7; }
        #result-container h2 { font-size: 20px; color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; margin-top: 25px; }
        /* Welcome message specific style */
        #result-container .welcome-message h2 { border-bottom: none; margin-top: 0; }
        .sources-container { margin-top: 20px; font-size: 14px; }
        .sources-container a { color: var(--text-secondary-color); text-decoration: none; }
        .sources-container a:hover { text-decoration: underline; }
        .spinner { border: 3px solid rgba(255,255,255,0.2); width: 18px; height: 18px; border-radius: 50%; border-left-color: #fff; animation: spin 1s ease infinite; display: inline-block; vertical-align: middle; margin-left: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .citation-link { color: var(--primary-color); text-decoration: none; font-weight: bold; vertical-align: super; font-size: 0.8em; margin: 0 2px; }
        .citation-link:hover { text-decoration: underline; }
        .source-item { display: flex; align-items: center; padding: 4px 0; }
        .lang-toggle { display: flex; border: 1px solid var(--border-color); border-radius: 20px; overflow: hidden; background-color: var(--surface-color); }
        .lang-toggle button { background: none; border: none; color: var(--text-secondary-color); padding: 8px 16px; cursor: pointer; transition: all 0.2s ease-in-out; font-size: 15px; font-weight: 500; }
        .lang-toggle button:not(:last-child) { border-right: 1px solid var(--border-color); }
        .lang-toggle button.active { background-color: var(--primary-color); color: white; }
        .lang-toggle button:hover:not(.active) { color: var(--text-color); }
        .source-icon { width: 16px; height: 16px; margin-right: 8px; flex-shrink: 0; color: var(--text-secondary-color); }
        
        .coffee-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary-color);
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }
        .coffee-button:hover {
            color: var(--text-color);
            background-color: var(--surface-color);
            border-color: var(--text-color);
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="logo" id="logo">🔬 职场透镜</div>
        <div class="controls">
            <a href="https://buymeacoffee.com/200203sytty" target="_blank" rel="noopener noreferrer" class="coffee-button">
                <span>☕️</span>
                <span data-key="support_text">请开发者喝杯咖啡</span>
            </a>
            <button class="theme-switcher" id="theme-switcher">☀️</button>
            <div class="lang-toggle" id="lang-toggle">
                <button data-lang="zh-CN">简</button>
                <button data-lang="zh-TW">繁</button>
                <button data-lang="en">EN</button>
            </div>
        </div>
    </header>

    <main class="main-container">
        <section class="panel input-panel">
            <div>
                <h1 data-key="title">输入信息</h1>
                <p class="subtitle" data-key="subtitle">AI将自动搜索并分析该公司</p>
                <div class="form-group">
                    <label for="company-name" data-key="company_name_label">公司名称</label>
                    <input type="text" id="company-name" data-key-placeholder="company_name_placeholder">
                </div>
                <div class="form-group">
                    <label for="job-title" data-key="job_title_label">职位名称 (可选)</label>
                    <input type="text" id="job-title" data-key-placeholder="job_title_placeholder">
                </div>
                <div class="form-group">
                    <label for="resume-text" data-key="resume_label">我的简历 / 个人简介 (可选)</label>
                    <textarea id="resume-text" rows="6" data-key-placeholder="resume_placeholder"></textarea>
                </div>
            </div>
            <button class="analyze-button" id="analyze-button">
                <span data-key="button_text">开始分析</span>
            </button>
        </section>

        <section class="panel output-panel">
            <div id="result-container">
                <div class="welcome-message">
                    <h2 data-key="welcome_title">欢迎来到Project Lens！</h2>
                    <p data-key="welcome_p1" style="color: var(--text-secondary-color); margin-top: 15px;"></p>
                    <p data-key="welcome_p2" style="color: var(--text-secondary-color); margin-top: 15px;"></p>
                </div>
            </div>
            <div class="sources-container" id="sources-container"></div>
        </section>
    </main>

    <script>
        // --- 1. 元素获取 ---
        const companyNameInput = document.getElementById('company-name');
        const jobTitleInput = document.getElementById('job-title');
        const resumeTextInput = document.getElementById('resume-text');
        const analyzeButton = document.getElementById('analyze-button');
        const resultContainer = document.getElementById('result-container');
        const sourcesContainer = document.getElementById('sources-container');
        const themeSwitcher = document.getElementById('theme-switcher');
        const logo = document.getElementById('logo');
        const langToggle = document.getElementById('lang-toggle');

        // --- 2. API 配置 ---
        const API_URL = 'https://project-lens-backend-885033581194.us-central1.run.app/analyze'; 

        // --- 3. 国际化 (i18n) 配置 ---
        const translations = {
            'zh-CN': { 
                logo_text: '🔬 职场透镜', title: '输入信息', subtitle: 'AI将自动搜索并分析该公司', 
                company_name_label: '公司名称', company_name_placeholder: '例如：西安大略大学', 
                job_title_label: '职位名称 (可选)', job_title_placeholder: '例如：软件工程师, 市场经理', 
                resume_label: '我的简历 / 个人简介 (可选)', resume_placeholder: '粘贴你的个人简介或简历，获得更精准的匹配分析...', 
                button_text: '开始分析', button_loading_text: '分析中...', 
                sources_title: '引用来源:',
                rate_limit_exceeded: "开拓者，您今日的免费分析额度已用尽！🚀\n\nProject Lens 每天为所有用户提供10次免费分析。\n如果您是需要进行大量研究的‘超级用户’，可以考虑升级到 Pro 版本，或通过‘请我喝杯咖啡☕️’来立即重置额度！",
                connection_error: "发生连接错误，请检查网络或联系开发者。",
                support_text: "请开发者喝杯咖啡",
                welcome_title: "欢迎来到 Project Lens！",
                welcome_p1: "我能帮你一键分析公司文化，避免求职踩坑。",
                welcome_p2: "请在左侧输入公司名，开始你的第一次探索吧！为了获得最精准的结果，请输入公司的官方全称，或在大学名后加上校区/省份 (e.g., University of Western Ontario / UWO)。",
                loading_statuses: [
                    "正在连接AI大脑...",
                    "正在全网搜索公司信息...",
                    "正在阅读相关新闻与评价...",
                    "正在召唤 Gemini 进行深度分析...",
                    "即将完成，正在生成报告..."
                ]
            },
            'zh-TW': { 
                logo_text: '🔬 職場透鏡', title: '输入資訊', subtitle: 'AI將自動搜索並分析該公司', 
                company_name_label: '公司名稱', company_name_placeholder: '例如：西安大略大學', 
                job_title_label: '職位名稱 (可選)', job_title_placeholder: '例如：軟體工程師, 市場經理', 
                resume_label: '我的履歷 / 個人簡介 (可選)', resume_placeholder: '貼上你的個人簡介或履歷，獲得更精準的匹配分析...', 
                button_text: '開始分析', button_loading_text: '分析中...', 
                sources_title: '資訊來源:',
                rate_limit_exceeded: "開拓者，您今日的免費分析額度已用盡！🚀\n\nProject Lens 每天為所有用戶提供10次免費分析。\n如果您是需要進行大量研究的「超級用戶」，可以考慮升級到 Pro 版本，或通過「請我喝杯咖啡☕️」來立即重置額度！",
                connection_error: "發生連接錯誤，請檢查網路或聯絡開發者。",
                support_text: "請開發者喝杯咖啡",
                welcome_title: "歡迎來到 Project Lens！",
                welcome_p1: "我能幫你一鍵分析公司文化，避免求職踩坑。",
                welcome_p2: "請在左側輸入公司名，開始你的第一次探索吧！為了獲得最精準的結果，請輸入公司的官方全稱，或在大學名後加上校區/省份 (e.g., University of Western Ontario / UWO)。",
                 loading_statuses: [
                    "正在連接AI大腦...",
                    "正在全網搜尋公司資訊...",
                    "正在閱讀相關新聞與評價...",
                    "正在召喚 Gemini 進行深度分析...",
                    "即將完成，正在生成報告..."
                ]
            },
            'en': { 
                logo_text: '🔬 Project Lens', title: 'Input Information', subtitle: 'AI will automatically search and analyze the company', 
                company_name_label: 'Company Name', company_name_placeholder: 'e.g., University of Western Ontario', 
                job_title_label: 'Job Title (Optional)', job_title_placeholder: 'e.g., Software Engineer, Marketing Manager', 
                resume_label: 'My Resume / Bio (Optional)', resume_placeholder: 'Paste your bio or resume for a more accurate culture-fit analysis...', 
                button_text: 'Analyze', button_loading_text: 'Analyzing...', 
                sources_title: 'References:',
                rate_limit_exceeded: "Explorer, you have used up your free analysis quota for today! 🚀\n\nProject Lens provides 10 free analyses per day for all users.\nIf you are a 'power user' who needs to conduct a lot of research, consider upgrading to the Pro version or 'Buy me a coffee ☕️' to reset your quota immediately!",
                connection_error: "Connection error. Please check your network or contact the developer.",
                support_text: "Buy the developer a coffee",
                welcome_title: "Welcome to Project Lens!",
                welcome_p1: "I can help you analyze company culture with one click to avoid job-hunting pitfalls.",
                welcome_p2: "Please enter a company name on the left to start your first exploration! For the most accurate results, please enter the company's official full name, or add the campus/province after a university's name (e.g., University of Western Ontario / UWO).",
                loading_statuses: [
                    "Connecting to the AI brain...",
                    "Searching for company info across the web...",
                    "Reading related news and reviews...",
                    "Summoning Gemini for deep analysis...",
                    "Finalizing, generating report..."
                ]
            }
        };
        
        const ICONS = {
            linkedin: `<svg class="source-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"/></svg>`,
            glassdoor: `<svg class="source-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.185 1.185A1.5 1.5 0 0 1 2.57.293l10.854 10.854a.5.5 0 0 1 0 .708L11.146 14a.5.5 0 0 1-.708 0L.293 2.854A1.5 1.5 0 0 1 1.185 1.185zM14.815 1.185a1.5 1.5 0 0 0-2.122 0L.854 13.146a.5.5 0 0 0 0 .708L2.854 15.707a.5.5 0 0 0 .708 0L15.707 3.565a1.5 1.5 0 0 0 0-2.122l-.892-.892z"/></svg>`,
            indeed: `<svg class="source-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M13.555 5.582a.363.363 0 0 0-.363.363v4.062a.363.363 0 0 0 .363.363h.363a.363.363 0 0 0 .363-.363V5.945a.363.363 0 0 0-.363-.363h-.363zM10.31 5.582a.363.363 0 0 0-.363.363v4.062a.363.363 0 0 0 .363.363h.363a.363.363 0 0 0 .363-.363V5.945a.363.363 0 0 0-.363-.363h-.363zM8.36 5.582a.363.363 0 0 0-.363.363v4.062a.363.363 0 0 0 .363.363h.363a.363.363 0 0 0 .363-.363V5.945a.363.363 0 0 0-.363-.363h-.363zM5.945 5.582a.363.363 0 0 0-.363.363v4.062a.363.363 0 0 0 .363.363h.363a.363.363 0 0 0 .363-.363V5.945a.363.363 0 0 0-.363-.363h-.363zM15.363 4.091A1.91 1.91 0 0 0 13.455 2.182h-10.91A1.91 1.91 0 0 0 .636 4.091v7.818A1.91 1.91 0 0 0 2.545 13.818h10.91a1.91 1.91 0 0 0 1.909-1.909V4.091zM2.909 5.227a1.136 1.136 0 1 1 0 2.273 1.136 1.136 0 0 1 0-2.273z"/></svg>`,
            default: `<svg class="source-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"/><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"/></svg>`
        };

        // --- 4. 核心逻辑 ---
        let currentLang = 'zh-CN';
        let loadingInterval = null;

        function setLanguage(langCode) {
            currentLang = langCode;
            document.documentElement.lang = langCode;
            const t = translations[langCode];
            document.querySelectorAll('[data-key]').forEach(elem => { const key = elem.getAttribute('data-key'); if (t[key]) elem.textContent = t[key]; });
            document.querySelectorAll('[data-key-placeholder]').forEach(elem => { const key = elem.getAttribute('data-key-placeholder'); if (t[key]) elem.placeholder = t[key]; });
            logo.textContent = t.logo_text;
            langToggle.querySelectorAll('button').forEach(button => button.classList.toggle('active', button.dataset.lang === langCode));
        }

        function setTheme(theme) {
            document.documentElement.classList.toggle('light-mode', theme === 'light');
            themeSwitcher.textContent = theme === 'light' ? '🌙' : '☀️';
            localStorage.setItem('theme', theme);
        }

        analyzeButton.addEventListener('click', async function() {
            const t = translations[currentLang];
            const buttonTextSpan = analyzeButton.querySelector('span');
            
            buttonTextSpan.textContent = t.button_loading_text;
            analyzeButton.insertAdjacentHTML('beforeend', '<div class="spinner"></div>');
            analyzeButton.disabled = true;
            sourcesContainer.innerHTML = '';

            let statusIndex = 0;
            const loadingStatuses = t.loading_statuses;
            resultContainer.innerHTML = `<p>${loadingStatuses[statusIndex]}</p>`;
            statusIndex++;
            
            loadingInterval = setInterval(() => {
                if (statusIndex < loadingStatuses.length) {
                    resultContainer.innerHTML = `<p>${loadingStatuses[statusIndex]}</p>`;
                    statusIndex++;
                } else {
                    clearInterval(loadingInterval);
                }
            }, 2500);

            const data = { companyName: companyNameInput.value, jobTitle: jobTitleInput.value, resumeText: resumeTextInput.value, language: currentLang };

            try {
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                const result = await response.json();

                if (loadingInterval) clearInterval(loadingInterval);

                if (response.ok) {
                    let analysisHtml = marked.parse(result.analysis || '');
                    
                    // 将 [1] 格式的引用转换为链接
                    analysisHtml = analysisHtml.replace(/\[(\d+)\]/g, (match, number) => `<a href="#source-${number}" class="citation-link">${match}</a>`);
                    
                    // *** 修改开始：新增代码以处理 (Source ID: ...) 格式 ***
                    analysisHtml = analysisHtml.replace(/\(Source ID: ([\d, ]+)\)/g, (match, numbersString) => {
                        // 将 "1, 2, 3" 这样的字符串分割成数字数组
                        const numbers = numbersString.split(',').map(s => s.trim()).filter(s => s);
                        // 为每个数字创建一个链接
                        const links = numbers.map(number => `<a href="#source-${number}" class="citation-link">[${number}]</a>`);
                        // 将链接用逗号和空格重新组合
                        return links.join(', ');
                    });
                    // *** 修改结束 ***

                    resultContainer.innerHTML = DOMPurify.sanitize(analysisHtml);
                    
                    if (result.sources && result.sources.length > 0) {
                        let sourcesHTML = `<h2>${t.sources_title}</h2>`;
                        result.sources.forEach(source => {
                            const icon = ICONS[source.source_type] || ICONS.default;
                            sourcesHTML += `<div class="source-item" id="source-${source.id}">
                                              ${icon}
                                              <span>[${source.id}] <a href="${source.link}" target="_blank" rel="noopener noreferrer">${source.title}</a></span>
                                          </div>`;
                        });
                        sourcesContainer.innerHTML = DOMPurify.sanitize(sourcesHTML, {ADD_ATTR: ['id'], ADD_TAGS: ['svg', 'path']});
                    }
                } else {
                     if (response.status === 429 || result.error === 'rate_limit_exceeded') {
                        resultContainer.innerHTML = `<h2 style="color: var(--primary-color);">Quota Reached</h2><p style="white-space: pre-wrap;">${t.rate_limit_exceeded}</p>`;
                    } else {
                        resultContainer.innerHTML = `<h2>Error</h2><p>${result.error || 'Unknown error'}</p>`;
                    }
                }
            } catch (error) {
                if (loadingInterval) clearInterval(loadingInterval);
                const t = translations[currentLang];
                resultContainer.innerHTML = `<h2>Error</h2><p>${t.connection_error}</p>`;
                console.error("Fetch Error:", error);
            } finally {
                if (loadingInterval) clearInterval(loadingInterval);
                const t = translations[currentLang];
                buttonTextSpan.textContent = t.button_text;
                if(analyzeButton.querySelector('.spinner')) analyzeButton.querySelector('.spinner').remove();
                analyzeButton.disabled = false;
            }
        });

        // --- 5. 初始化 ---
        themeSwitcher.addEventListener('click', () => setTheme(document.documentElement.classList.contains('light-mode') ? 'dark' : 'light'));
        langToggle.addEventListener('click', (event) => { if (event.target.tagName === 'BUTTON') { const langCode = event.target.dataset.lang; if (langCode && langCode !== currentLang) { setLanguage(langCode); } } });
        setTheme(localStorage.getItem('theme') || 'dark');
        setLanguage('zh-CN');
    </script>
</body>
</html>


